<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PDF FLOW — App</title>
<meta name="description" content="PDFテンプレートにデータを差し込み一括生成。ブラウザ完結。">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#f8fafc;--fg:#1e293b;--muted:#64748b;--border:#e2e8f0;--card:#fff;--accent:#1e3a5f;--accent-h:#2d5a8e;--green:#059669;--green-bg:#ecfdf5;--amber:#d97706;--amber-bg:#fffbeb;--red:#dc2626;--r:12px;--rl:20px}
html{font-size:15px}
body{font-family:'DM Sans','Noto Sans JP',sans-serif;background:var(--bg);color:var(--fg);-webkit-font-smoothing:antialiased;min-height:100vh}
input,button,select,textarea{font:inherit;color:inherit}
button{cursor:pointer;border:none;background:none}

/* Layout */
.wrap{max-width:1040px;margin:0 auto;padding:0 20px}

/* Header */
header{background:rgba(255,255,255,.85);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
header .inner{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.logo{display:flex;align-items:center;gap:10px}
.logo-mark{width:32px;height:32px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:12px}
.logo-t{font-size:14px;font-weight:800;letter-spacing:-.02em;line-height:1}
.logo-s{font-size:11px;color:var(--muted);line-height:1;margin-top:2px}
.hdr-r{display:flex;align-items:center;gap:8px}
.dot-live{width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block}
.badge{padding:3px 8px;border-radius:4px;font-size:11px;font-weight:700;background:#f1f5f9;color:var(--muted)}
.badge-pro{background:#ede9fe;color:#7c3aed}
.btn{display:inline-flex;align-items:center;gap:5px;padding:8px 18px;border-radius:10px;font-size:13px;font-weight:600;transition:all .15s}
.btn-p{background:var(--accent);color:#fff}
.btn-p:hover{background:var(--accent-h);transform:translateY(-1px);box-shadow:0 4px 12px rgba(30,58,95,.2)}
.btn-o{border:1.5px solid var(--border);color:var(--fg)}
.btn-o:hover{border-color:var(--accent);color:var(--accent)}
.btn-s{padding:6px 12px;font-size:12px}
.btn-ghost{color:var(--muted);padding:8px}
.btn-ghost:hover{background:#f1f5f9;color:var(--fg);border-radius:8px}
.icon-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all .15s}
.icon-btn:hover{background:#f1f5f9}
.icon-btn svg{width:18px;height:18px}

/* Steps */
.steps{display:flex;align-items:center;justify-content:center;gap:4px;margin:28px 0}
.step{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:100px;font-size:12px;font-weight:600;transition:all .2s}
.step .num{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px}
.step-active{background:var(--accent);color:#fff}
.step-active .num{background:#fff;color:var(--accent)}
.step-done{background:var(--green-bg);color:var(--green)}
.step-done .num{background:var(--green);color:#fff}
.step-pending{background:#f1f5f9;color:#94a3b8}
.step-pending .num{background:#e2e8f0;color:#94a3b8}
.step-line{width:24px;height:1px;background:var(--border)}
.step-line-done{background:#a7f3d0}
.step-label{display:none}
@media(min-width:640px){.step-label{display:inline}}

/* Cards */
.card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:24px;transition:all .2s}
.card:hover{border-color:#cbd5e1}
.card.selected{border-color:var(--accent);background:#f8fafc;box-shadow:0 0 0 2px rgba(30,58,95,.08)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px}

/* Template cards */
.tmpl-icon{color:var(--muted);margin-bottom:12px}
.tmpl-icon svg{width:28px;height:28px}
.tmpl-name{font-size:15px;font-weight:700;margin-bottom:2px}
.tmpl-en{font-size:11px;color:var(--muted)}
.tmpl-desc{font-size:12px;color:var(--muted);margin-top:4px}
.tmpl-fields{font-size:11px;color:#94a3b8;margin-top:8px}
.tmpl-check{position:absolute;top:10px;right:10px;width:22px;height:22px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px}

/* Section */
.sec-title{font-size:20px;font-weight:700;letter-spacing:-.02em;margin-bottom:4px}
.sec-sub{font-size:13px;color:var(--muted);margin-bottom:20px}

/* Form */
.field{margin-bottom:8px}
.field label{display:block;font-size:11px;color:var(--muted);margin-bottom:3px;font-weight:500}
.field input,.field select,.field textarea{width:100%;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:#fff;transition:border-color .15s;outline:none}
.field input:focus,.field select:focus{border-color:var(--accent)}
.field input::placeholder{color:#cbd5e1}

/* Tabs */
.tabs{display:flex;gap:4px;margin-bottom:14px}
.tab{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;color:var(--muted);transition:all .15s}
.tab:hover{background:#f1f5f9}
.tab.active{background:var(--accent);color:#fff}

/* Data rows */
.data-row{background:#f8fafc;border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:10px}
.data-row-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.data-row-num{font-size:11px;font-weight:700;color:#94a3b8}
.data-row-actions{display:flex;gap:4px}
.data-row-actions button{font-size:11px;padding:3px 8px;border-radius:4px;color:var(--muted)}
.data-row-actions button:hover{background:#e2e8f0}
.data-row-actions .del:hover{background:#fee2e2;color:var(--red)}
.data-fields{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:6px}

/* File drop */
.file-drop{border:2px dashed var(--border);border-radius:var(--r);padding:40px;text-align:center;cursor:pointer;transition:all .2s}
.file-drop:hover{border-color:var(--accent);background:#f8fafc}
.file-drop svg{margin:0 auto 8px;color:var(--muted)}
.file-drop p{font-size:13px;font-weight:600;color:var(--fg)}
.file-drop span{font-size:11px;color:var(--muted)}

/* Preview */
.preview-nav{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.preview-nav button{padding:6px 12px;background:#f1f5f9;border-radius:8px;font-size:13px;font-weight:500}
.preview-nav button:disabled{opacity:.3}
.preview-nav span{font-size:13px;font-weight:600;color:var(--muted)}
.preview-frame{background:#f1f5f9;border:1px solid var(--border);border-radius:var(--rl);overflow:hidden;height:500px}
.preview-frame iframe{width:100%;height:100%;border:0}

/* Generate */
.gen-format{display:flex;gap:12px;margin-bottom:16px}
.gen-opt{flex:1;padding:16px;border:2px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all .15s}
.gen-opt:hover{border-color:#cbd5e1}
.gen-opt.active{border-color:var(--accent);background:#fff}
.gen-opt svg{color:var(--muted);margin-bottom:8px}
.gen-opt .go-t{font-size:14px;font-weight:600}
.gen-opt .go-s{font-size:11px;color:var(--muted);margin-top:2px}

/* Usage bar */
.usage{margin-bottom:16px}
.usage-hdr{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px}
.usage-bar{height:5px;background:#f1f5f9;border-radius:100px;overflow:hidden}
.usage-fill{height:100%;border-radius:100px;transition:width .3s}

/* Privacy box */
.priv{display:flex;gap:10px;align-items:flex-start;padding:14px;background:var(--green-bg);border:1px solid #a7f3d0;border-radius:var(--r);margin-bottom:16px}
.priv svg{width:20px;height:20px;color:var(--green);flex-shrink:0;margin-top:1px}
.priv .priv-t{font-size:13px;font-weight:600;color:#065f46}
.priv .priv-s{font-size:11px;color:#047857;margin-top:2px}

/* Limit banner */
.limit-ban{display:flex;gap:12px;align-items:flex-start;padding:18px;background:var(--amber-bg);border:1px solid #fcd34d;border-radius:var(--r);margin-bottom:16px}
.limit-ban .lb-icon{width:32px;height:32px;background:#fef3c7;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.limit-ban .lb-icon svg{width:14px;height:14px;color:var(--amber)}
.limit-ban .lb-t{font-size:13px;font-weight:700;color:#92400e}
.limit-ban .lb-s{font-size:11px;color:#a16207;margin-top:2px}

/* Watermark notice */
.wm-notice{display:flex;align-items:center;gap:6px;padding:10px;background:#f8fafc;border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--muted);margin-bottom:12px}
.wm-notice svg{width:14px;height:14px;flex-shrink:0}
.wm-notice a{color:var(--accent);font-weight:600;text-decoration:underline;text-underline-offset:2px}

/* Progress */
.progress-wrap{text-align:center;padding:48px 0}
.progress-bar{width:200px;height:6px;background:#f1f5f9;border-radius:100px;margin:0 auto 14px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);border-radius:100px;transition:width .2s}

/* Done */
.done-wrap{text-align:center;padding:32px 0}
.done-icon{color:var(--green);margin-bottom:14px}
.done-icon svg{width:40px;height:40px}
.done-t{font-size:18px;font-weight:700;margin-bottom:6px}
.done-s{font-size:13px;color:var(--muted);margin-bottom:24px}

/* Settings panel */
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);backdrop-filter:blur(4px);z-index:200;display:none}
.settings-overlay.open{display:flex;justify-content:flex-end}
.settings-panel{width:100%;max-width:400px;background:#fff;height:100%;overflow-y:auto;box-shadow:-4px 0 24px rgba(0,0,0,.1)}
.sp-hdr{position:sticky;top:0;background:#fff;padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;z-index:1}
.sp-hdr .sp-title{font-weight:700;font-size:15px}
.sp-hdr .sp-sub{font-size:11px;color:var(--muted)}
.sp-body{padding:20px}
.sp-section{margin-bottom:18px}
.sp-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:8px}
.sp-row{display:flex;gap:6px;margin-bottom:8px}
.sp-btn{flex:1;padding:8px;border:2px solid var(--border);border-radius:8px;font-size:12px;font-weight:600;text-align:center;transition:all .15s}
.sp-btn:hover{border-color:#cbd5e1}
.sp-btn.active{border-color:var(--accent);background:#f8fafc}
.sp-colors{display:flex;gap:4px;margin-left:auto}
.sp-color{width:24px;height:24px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.15);cursor:pointer}
.sp-range{width:100%;accent-color:var(--accent)}

/* Upgrade modal */
.upgrade-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);z-index:300;display:none;align-items:center;justify-content:center;padding:16px}
.upgrade-overlay.open{display:flex}
.upgrade-modal{background:#fff;border-radius:var(--rl);max-width:480px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.15);overflow:hidden}
.um-hdr{padding:20px 24px;border-bottom:1px solid var(--border)}
.um-hdr h3{font-size:17px;font-weight:700}
.um-hdr p{font-size:12px;color:var(--muted);margin-top:2px}
.um-body{padding:20px 24px}
.um-plan{border:2px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:10px;cursor:pointer;transition:all .15s}
.um-plan:hover{border-color:var(--accent)}
.um-plan-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.um-plan-price{font-size:14px;font-weight:700}
.um-plan-feat{font-size:11px;color:var(--muted)}
.um-plan-soon{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px}
.um-foot{padding:0 24px 20px}

/* Responsive */
@media(max-width:640px){
  .card-grid{grid-template-columns:1fr 1fr}
  .data-fields{grid-template-columns:1fr}
  .gen-format{flex-direction:column}
  .preview-frame{height:360px}
}

/* Nav buttons */
.nav-row{display:flex;justify-content:space-between;margin-top:24px}

/* Hidden */
.hidden{display:none!important}
</style>
</head>
<body>
<header>
<div class="wrap inner">
  <div class="logo">
    <div class="logo-mark">F</div>
    <div><div class="logo-t">PDF FLOW</div><div class="logo-s" id="hdr-sub"></div></div>
  </div>
  <div class="hdr-r">
    <span class="dot-live" style="margin-right:2px"></span>
    <span id="hdr-live" style="font-size:11px;color:var(--muted)"></span>
    <span class="badge" id="hdr-badge">Free</span>
    <button class="btn btn-s btn-o" id="hdr-upgrade" onclick="showUpgrade()"></button>
    <button class="btn btn-s btn-ghost" id="hdr-auth" onclick="handleAuthBtn()"></button>
    <button class="icon-btn" onclick="openSettings()" title="Settings">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    </button>
  </div>
</div>
</header>

<main class="wrap" style="padding-top:24px;padding-bottom:48px">
  <div id="step-bar" class="steps"></div>
  <div id="app-content"></div>
</main>

<!-- Settings Panel -->
<div class="settings-overlay" id="settings-overlay">
  <div class="settings-panel" id="settings-panel"></div>
</div>

<!-- Upgrade Modal -->
<div class="upgrade-overlay" id="upgrade-overlay">
  <div class="upgrade-modal" id="upgrade-modal"></div>
</div>

<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ============================================================
// PDF FLOW — Vanilla JS App
// ============================================================

// --- i18n ---
const L={ja:{
appSub:"テンプレートからPDF一括生成",browserOnly:"ブラウザ内処理",
steps:["テンプレート選択","データ入力","プレビュー","一括生成"],
selectT:"テンプレートを選択",selectTSub:"用途にあったテンプレートを選んでください",
fields:"フィールド",next:"次へ →",back:"← 戻る",
dataInput:"データを入力",dataInputSub:"手入力またはファイルから取り込めます",
manual:"手入力",fileImport:"ファイル取込",
fileDrop:"クリックしてファイルを選択",fileTypes:"CSV / Excel (.xlsx) / JSON に対応",
loaded:"件読み込み",sample:"サンプルデータで試す",addRow:"+ 行を追加",
dup:"複製",del:"削除",preview:"プレビュー",previewOf:"件中",previewShow:"件目",
gen:"生成中...",batchGen:"一括生成",batchSub:"件を生成。すべてブラウザ内で処理されます。",
outFmt:"出力形式",zipL:"ZIP（個別PDF）",zipS:"1件1ファイル",mergeL:"結合PDF",mergeS:"全件を1つに",
priv:"プライバシー保護",privS:"データはサーバーに送信されません",
genBtn:"件を生成する",done:"生成完了",doneSub:"件が生成されました",dl:"ダウンロード",retry:"もう一度",
settings:"設定",settingsSub:"カスタマイズ",close:"閉じる",
taxSet:"税金設定",taxName:"税名",taxRate:"税率(%)",
taxExcl:"税別",taxIncl:"税込",noTax:"なし",
currency:"通貨",symbol:"記号",symPos:"位置",pre:"前($100)",suf:"後(100€)",
deci:"小数桁",thousSep:"桁区切り",
dateFmt:"日付フォーマット",items:"品目数",
accent:"アクセントカラー",lang:"言語",
company:"自社情報",coName:"会社名/屋号",coAddr:"住所",
coTel:"電話番号",coEmail:"メール",coTaxId:"登録番号/VAT",coBank:"振込先",
upgrade:"アップグレード",upgradeT:"プランをアップグレード",
upgradeSub:"より多くのPDFを生成、ウォーターマークなし",
perMo:"/月",soon:"準備中",
usage:"今月",limit:"上限",unlimited:"無制限",
limitReached:"月間上限に達しました",limitSub:"アップグレードすると制限解除",
wm:"ウォーターマーク付き",
featStd:"月100件 / ウォーターマークなし / テンプレ保存5件",
featPro:"月500件 / 無制限テンプレ / API利用可",
featBiz:"無制限 / チーム共有 / 優先サポート",
// Templates
tInv:"請求書",tQt:"見積書",tRc:"領収書",tDl:"納品書",
tInvD:"取引先への請求に",tQtD:"見積りの提示に",tRcD:"受領の証明に",tDlD:"納品物の確認に",
// PDF
pInv:"請 求 書",pQt:"見 積 書",pRc:"領 収 書",pDl:"納 品 書",
pInvNo:"請求書番号",pQtNo:"見積番号",pRcNo:"領収書番号",pDlNo:"納品書番号",
pDate:"発行日",pDlDate:"納品日",pDue:"支払期限",pValid:"有効期限",
pDear:"御中",pSama:"様",pItem:"品目",pQty:"数量",pPrice:"単価",pAmt:"金額",
pSub:"小計",pTaxLn:"{n} ({r}%)",pTotal:"合計",
pTotalI:"合計金額（税込）",pNote:"備考",pBank:"振込先",
pFor:"但し書き",pIssuer:"発行者",pPreTax:"税抜金額",pTaxAmt:"税額",
pFooter:"PDF FLOW で作成",pTel:"TEL",pEmail:"Email",pTaxId:"登録番号",
// Fields
fNo:"番号",fDate:"発行日",fDue:"支払期限",fValid:"有効期限",
fClient:"宛先名",fAddr:"宛先住所",fItem:"品目",fQty:"数量",fPrice:"単価",
fNote:"備考",fAmt:"金額",fDetail:"但し書き",
fileErr:"CSV, Excel (.xlsx), JSON に対応",noData:"データなし",readErr:"読み込みエラー",
},en:{
appSub:"Batch PDF from templates",browserOnly:"Browser-side",
steps:["Template","Data Input","Preview","Generate"],
selectT:"Select a Template",selectTSub:"Choose a template that fits your needs",
fields:"fields",next:"Next →",back:"← Back",
dataInput:"Enter Data",dataInputSub:"Input manually or import from a file",
manual:"Manual",fileImport:"File Import",
fileDrop:"Click to select a file",fileTypes:"CSV / Excel (.xlsx) / JSON",
loaded:"rows loaded",sample:"Try sample data",addRow:"+ Add row",
dup:"Duplicate",del:"Delete",preview:"Preview",previewOf:"of",previewShow:"showing",
gen:"Generating...",batchGen:"Batch Generate",batchSub:"documents. All in your browser.",
outFmt:"Output Format",zipL:"ZIP (individual)",zipS:"One file each",mergeL:"Merged PDF",mergeS:"All in one",
priv:"Privacy Protected",privS:"No data sent to any server",
genBtn:"documents",done:"Complete",doneSub:"documents generated",dl:"Download",retry:"Again",
settings:"Settings",settingsSub:"Customize",close:"Close",
taxSet:"Tax",taxName:"Tax Name",taxRate:"Rate(%)",
taxExcl:"Exclusive",taxIncl:"Inclusive",noTax:"None",
currency:"Currency",symbol:"Symbol",symPos:"Position",pre:"Before($100)",suf:"After(100€)",
deci:"Decimals",thousSep:"Thousands",
dateFmt:"Date Format",items:"Items",
accent:"Accent",lang:"Language",
company:"Company Info",coName:"Company Name",coAddr:"Address",
coTel:"Phone",coEmail:"Email",coTaxId:"Tax ID/VAT",coBank:"Bank Details",
upgrade:"Upgrade",upgradeT:"Upgrade Plan",
upgradeSub:"More PDFs, no watermarks",
perMo:"/mo",soon:"Coming Soon",
usage:"This month",limit:"Limit",unlimited:"Unlimited",
limitReached:"Monthly limit reached",limitSub:"Upgrade to unlock more",
wm:"With watermark",
featStd:"100/mo / No watermark / 5 saved templates",
featPro:"500/mo / Unlimited saves / API access",
featBiz:"Unlimited / Team sharing / Priority support",
tInv:"Invoice",tQt:"Quotation",tRc:"Receipt",tDl:"Delivery Slip",
tInvD:"Bill clients",tQtD:"Present a quote",tRcD:"Proof of payment",tDlD:"Confirm deliveries",
pInv:"INVOICE",pQt:"QUOTATION",pRc:"RECEIPT",pDl:"DELIVERY SLIP",
pInvNo:"Invoice No.",pQtNo:"Quote No.",pRcNo:"Receipt No.",pDlNo:"Delivery No.",
pDate:"Date",pDlDate:"Delivery Date",pDue:"Due Date",pValid:"Valid Until",
pDear:"",pSama:"",pItem:"Description",pQty:"Qty",pPrice:"Unit Price",pAmt:"Amount",
pSub:"Subtotal",pTaxLn:"{n} ({r}%)",pTotal:"Total",
pTotalI:"Total (Tax Incl.)",pNote:"Notes",pBank:"Bank Details",
pFor:"For",pIssuer:"Issued by",pPreTax:"Before Tax",pTaxAmt:"Tax Amount",
pFooter:"Generated by PDF FLOW",pTel:"Tel",pEmail:"Email",pTaxId:"Tax ID",
fNo:"Number",fDate:"Date",fDue:"Due Date",fValid:"Valid Until",
fClient:"Client Name",fAddr:"Client Address",fItem:"Description",fQty:"Qty",fPrice:"Unit Price",
fNote:"Notes",fAmt:"Amount",fDetail:"Details",
fileErr:"CSV, Excel (.xlsx), JSON",noData:"No data found",readErr:"Read error",
}};

// ============================================================
// API Configuration
// ============================================================
// Set this to your Worker URL to enable auth + Stripe.
// While null, everything runs in localStorage mock mode.
const API_URL = "https://pdfflow.mamonis.studio/api";

// --- API Client ---
function getSession(){try{return localStorage.getItem("pf_session")||null;}catch{return null;}}
function setSession(tk){try{if(tk)localStorage.setItem("pf_session",tk);else localStorage.removeItem("pf_session");}catch{}}
async function api(method,path,body){
  const headers={"Content-Type":"application/json"};
  const s=getSession();if(s)headers["Authorization"]="Bearer "+s;
  const res=await fetch(API_URL+path,{method,headers,body:body?JSON.stringify(body):undefined});
  return res.json();
}
let userEmail=null;

// --- State ---
let S={
  lang:"ja",taxMode:"exclusive",taxName:"消費税",taxRate:10,
  currencySymbol:"¥",symbolPosition:"prefix",decimals:0,
  thousandSep:",",decimalSep:".",dateFormat:"YYYY年M月D日",
  accentColor:"#1e3a5f",maxItems:5,
  company:{name:"",address:"",tel:"",email:"",taxId:"",bank:""}
};
let plan="free",usage=0,step=0,selTmpl=null,dataRows=[],previewIdx=0,dlType="zip";
let fontBytes=null;

const PLANS={free:{limit:5,wm:true},standard:{limit:100,wm:false},pro:{limit:500,wm:false},business:{limit:-1,wm:false}};

// --- Init ---
async function init(){
  try{const s=localStorage.getItem("pf_s");if(s){const p=JSON.parse(s);Object.assign(S,p);if(p.company)S.company={...S.company,...p.company};}}catch{}

  // Check for session token in URL (from Magic Link redirect)
  const params=new URLSearchParams(location.search);
  const sessionParam=params.get("session");
  if(sessionParam){setSession(sessionParam);history.replaceState({},"",location.pathname);}

  if(API_URL&&getSession()){
    // Fetch user info from Worker
    try{
      const u=await api("GET","/auth/me");
      if(!u.error){plan=u.plan||"free";usage=u.usage||0;userEmail=u.email;}
      else{setSession(null);plan="free";}
    }catch{plan="free";}
  }else{
    // Local mock mode
    try{plan=localStorage.getItem("pf_plan")||"free";}catch{}
    const uk=usageKey();try{usage=parseInt(localStorage.getItem(uk)||"0");}catch{}
  }
  render();
  loadFontAsync();
}

function saveS(){try{localStorage.setItem("pf_s",JSON.stringify(S));}catch{}}
function usageKey(){const d=new Date();return`pf_u_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;}
async function addUsage(n){
  usage+=n;
  if(API_URL&&getSession()){
    try{await api("POST","/usage/increment",{count:n});}catch{}
  }else{
    try{localStorage.setItem(usageKey(),String(usage));}catch{}
  }
}

// --- Auth Actions ---
async function doLogin(email){
  if(!API_URL)return;
  return api("POST","/auth/login",{email});
}
async function doLogout(){
  if(API_URL&&getSession()){try{await api("POST","/auth/logout");}catch{}}
  setSession(null);userEmail=null;plan="free";usage=0;render();
}
async function doCheckout(planId){
  if(!API_URL){alert(t().soon);return;}
  const res=await api("POST","/stripe/create-checkout",{plan:planId});
  if(res.url)location.href=res.url;
}
async function doPortal(){
  if(!API_URL)return;
  const res=await api("POST","/stripe/portal");
  if(res.url)location.href=res.url;
}

function handleAuthBtn(){
  if(userEmail){
    if(confirm(S.lang==="ja"?"ログアウトしますか？":"Log out?")){doLogout();}
  }else{showUpgrade();}
}

// --- Helpers ---
function t(){return L[S.lang]||L.ja}
function h(tag,cls,html){const e=document.createElement(tag);if(cls)e.className=cls;if(html!==undefined)e.innerHTML=html;return e;}
function fmtN(n){const v=parseFloat(n);if(isNaN(v))return"";const f=v.toFixed(S.decimals);const[i,d]=f.split(".");const g=i.replace(/\B(?=(\d{3})+(?!\d))/g,S.thousandSep);return S.decimals>0?g+S.decimalSep+d:g;}
function fmtC(n){const f=fmtN(n);if(!f)return"";return S.symbolPosition==="prefix"?S.currencySymbol+f:f+S.currencySymbol;}
function fmtD(ds){if(!ds)return"";const d=new Date(ds);if(isNaN(d))return ds;const Y=d.getFullYear(),M=d.getMonth()+1,D=d.getDate(),p=n=>String(n).padStart(2,"0");
switch(S.dateFormat){case"YYYY年M月D日":return`${Y}年${M}月${D}日`;case"MM/DD/YYYY":return`${p(M)}/${p(D)}/${Y}`;case"DD/MM/YYYY":return`${p(D)}/${p(M)}/${Y}`;case"YYYY-MM-DD":return`${Y}-${p(M)}-${p(D)}`;case"DD.MM.YYYY":return`${p(D)}.${p(M)}.${Y}`;default:return ds;}}

// SVG icons
const IC={
  inv:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  qt:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="15" y2="16"/></svg>',
  rc:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 2v20l3-2 3 2 3-2 3 2 3-2 3 2V2l-3 2-3-2-3 2-3-2-3 2z"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="13" y2="14"/></svg>',
  dl:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="1"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
  folder:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>',
  merge:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="8" height="8" rx="1"/><rect x="14" y="2" width="8" height="8" rx="1"/><rect x="8" y="14" width="8" height="8" rx="1"/><line x1="6" y1="10" x2="10" y2="14"/><line x1="18" y1="10" x2="14" y2="14"/></svg>',
  shield:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
  check:'<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
  lock:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>',
  arrow:'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>',
};

// --- Templates ---
function getTmpls(){
  const T=t();const mx=S.maxItems||5;
  const items=[];
  for(let i=1;i<=mx;i++){items.push({key:`item${i}_name`,label:T.fItem+i,ex:i===1?"Web Design":i===2?"Logo Design":""});items.push({key:`item${i}_qty`,label:T.fQty+i,ex:i<=2?"1":""});items.push({key:`item${i}_price`,label:T.fPrice+i,ex:i===1?"500000":i===2?"150000":""});}
  const cl=S.lang==="ja"?"株式会社サンプル":"Acme Corp.",ad=S.lang==="ja"?"東京都渋谷区1-2-3":"123 Main St";
  return{
    invoice:{id:"invoice",name:T.tInv,en:"Invoice",desc:T.tInvD,ic:IC.inv,fields:[{key:"invoice_no",label:T.fNo,ex:"INV-2026-001"},{key:"date",label:T.fDate,ex:"2026-02-16"},{key:"due_date",label:T.fDue,ex:"2026-03-16"},{key:"client_name",label:T.fClient,ex:cl},{key:"client_address",label:T.fAddr,ex:ad},...items,{key:"note",label:T.fNote,ex:""}]},
    quotation:{id:"quotation",name:T.tQt,en:"Quotation",desc:T.tQtD,ic:IC.qt,fields:[{key:"quote_no",label:T.fNo,ex:"QT-2026-001"},{key:"date",label:T.fDate,ex:"2026-02-16"},{key:"valid_until",label:T.fValid,ex:"2026-03-16"},{key:"client_name",label:T.fClient,ex:cl},{key:"client_address",label:T.fAddr,ex:ad},...items,{key:"note",label:T.fNote,ex:""}]},
    receipt:{id:"receipt",name:T.tRc,en:"Receipt",desc:T.tRcD,ic:IC.rc,fields:[{key:"receipt_no",label:T.fNo,ex:"RC-2026-001"},{key:"date",label:T.fDate,ex:"2026-02-16"},{key:"client_name",label:T.fClient,ex:cl},{key:"amount",label:T.fAmt,ex:"715000"},{key:"detail",label:T.fDetail,ex:S.lang==="ja"?"Webサイト制作費として":"Web development services"}]},
    delivery:{id:"delivery",name:T.tDl,en:"Delivery Slip",desc:T.tDlD,ic:IC.dl,fields:[{key:"delivery_no",label:T.fNo,ex:"DL-2026-001"},{key:"date",label:T.fDate,ex:"2026-02-16"},{key:"client_name",label:T.fClient,ex:cl},{key:"client_address",label:T.fAddr,ex:ad},...items,{key:"note",label:T.fNote,ex:""}]},
  };
}

// --- Font ---
async function loadFontAsync(){
  if(fontBytes)return fontBytes;
  const r=await fetch("https://cdn.jsdelivr.net/fontsource/fonts/noto-sans-jp@latest/japanese-400-normal.ttf");
  fontBytes=await r.arrayBuffer();return fontBytes;
}

// --- PDF Gen ---
async function genPdf(tmplId,data){
  const fb=await loadFontAsync();
  const{PDFDocument,rgb,degrees}=PDFLib;
  const doc=await PDFDocument.create();doc.registerFontkit(window.fontkit);
  const font=await doc.embedFont(fb);
  const W=595.28,H=841.89,mg=50;
  const T=t();
  const hex2rgb=c=>{const r=parseInt(c.slice(1,3),16)/255,g=parseInt(c.slice(3,5),16)/255,b=parseInt(c.slice(5,7),16)/255;return rgb(r,g,b);};
  const ac=hex2rgb(S.accentColor),bk=rgb(0,0,0),gr=rgb(.4,.4,.4),wh=rgb(1,1,1);
  const pg=doc.addPage([W,H]);
  const dr=(tx,x,y,sz=9,cl=bk)=>{pg.drawText(tx||"",{x,y,size:sz,font,color:cl});};
  const drR=(tx,rx,y,sz=9,cl=bk)=>{const w=font.widthOfTextAtSize(tx||"",sz);dr(tx,rx-w,y,sz,cl);};
  const dRect=(x,y,w,ht,cl)=>{pg.drawRectangle({x,y,width:w,height:ht,color:cl});};
  const dLine=(x1,y1,x2,y2,cl=rgb(.85,.85,.85),th=.5)=>{pg.drawLine({start:{x:x1,y:y1},end:{x:x2,y:y2},color:cl,thickness:th});};

  const co=S.company,cn=data.company_name||co.name||"",ca=data.company_address||co.address||"";
  const ct=co.tel||"",ce=co.email||"",ci=co.taxId||"",cb=data.bank_info||co.bank||"";

  // Items
  const its=[];for(let i=1;i<=(S.maxItems||10);i++){const nm=data[`item${i}_name`]||"",qt=parseFloat(data[`item${i}_qty`])||0,pr=parseFloat(data[`item${i}_price`])||0;if(nm)its.push({name:nm,qty:qt,price:pr,amt:qt*pr});}
  const sub=its.reduce((s,i)=>s+i.amt,0);let tax=0,tot=sub;
  if(S.taxMode==="exclusive"){tax=Math.floor(sub*S.taxRate/100);tot=sub+tax;}
  else if(S.taxMode==="inclusive"){tot=sub;tax=Math.floor(sub-sub/(1+S.taxRate/100));}
  const taxLbl=T.pTaxLn.replace("{n}",S.taxName).replace("{r}",S.taxRate);

  if(tmplId==="invoice"||tmplId==="quotation"||tmplId==="delivery"){
    const isI=tmplId==="invoice",isQ=tmplId==="quotation";
    const title=isI?T.pInv:isQ?T.pQt:T.pDl;
    const noL=isI?T.pInvNo:isQ?T.pQtNo:T.pDlNo;
    const noK=isI?"invoice_no":isQ?"quote_no":"delivery_no";
    const dL=tmplId==="delivery"?T.pDlDate:T.pDate;
    const sL=isI?T.pDue:isQ?T.pValid:"",sK=isI?"due_date":isQ?"valid_until":"";
    dRect(0,H-28,W,28,ac);dr(title,mg,H-72,20,ac);
    drR(`${noL}: ${data[noK]||""}`,W-mg,H-56,8.5,gr);
    drR(`${dL}: ${fmtD(data.date)}`,W-mg,H-70,8.5,gr);
    if(sL)drR(`${sL}: ${fmtD(data[sK])}`,W-mg,H-84,8.5,gr);
    dLine(mg,H-88,W-mg,H-88,ac,1.5);
    let cy=H-112;const sf=T.pDear?` ${T.pDear}`:"";dr(`${data.client_name||""}${sf}`,mg,cy,12,bk);cy-=18;
    if(data.client_address)dr(data.client_address,mg,cy,8.5,gr);
    let ry=H-112;drR(cn,W-mg,ry,10,bk);ry-=14;
    if(ca){drR(ca,W-mg,ry,7.5,gr);ry-=12;}if(ct){drR(`${T.pTel}: ${ct}`,W-mg,ry,7,gr);ry-=11;}
    if(ce){drR(`${T.pEmail}: ${ce}`,W-mg,ry,7,gr);ry-=11;}if(ci){drR(`${T.pTaxId}: ${ci}`,W-mg,ry,7,gr);ry-=11;}
    if(isI&&cb)drR(`${T.pBank}: ${cb}`,W-mg,ry,7,gr);
    const tbY=H-188;dRect(mg,tbY-4,W-mg*2,30,ac);
    dr(S.taxMode==="none"?T.pTotal:T.pTotalI,mg+12,tbY+4,9.5,wh);drR(fmtC(tot),W-mg-12,tbY+2,15,wh);
    const tY=tbY-38;dRect(mg,tY-2,W-mg*2,20,rgb(.95,.95,.97));
    const cols=[mg,mg+220,mg+280,mg+370];
    [T.pItem,T.pQty,T.pPrice,T.pAmt].forEach((l,i)=>dr(l,cols[i]+4,tY+2,7.5,gr));
    dLine(mg,tY-2,W-mg,tY-2,rgb(.85,.85,.85));
    let rY=tY-22;its.forEach((it,idx)=>{
      if(idx%2===1)dRect(mg,rY-3,W-mg*2,20,rgb(.98,.98,.99));
      dr(it.name,cols[0]+4,rY+2,8.5,bk);drR(String(it.qty),cols[2]-10,rY+2,8.5,bk);
      drR(fmtC(it.price),cols[3]-10,rY+2,8.5,bk);drR(fmtC(it.amt),W-mg-8,rY+2,8.5,bk);
      dLine(mg,rY-3,W-mg,rY-3,rgb(.92,.92,.92),.3);rY-=20;});
    dLine(cols[2],rY-2,W-mg,rY-2,rgb(.85,.85,.85));rY-=8;
    dr(T.pSub,cols[2]+4,rY,8,gr);drR(fmtC(sub),W-mg-8,rY,8.5,bk);
    if(S.taxMode!=="none"){rY-=16;dr(taxLbl,cols[2]+4,rY,8,gr);drR(fmtC(tax),W-mg-8,rY,8.5,bk);}
    rY-=16;dLine(cols[2],rY+10,W-mg,rY+10,ac,1);dr(T.pTotal,cols[2]+4,rY,8.5,ac);drR(fmtC(tot),W-mg-8,rY,10,ac);
    if(data.note){rY-=36;dr(T.pNote,mg,rY,8,gr);rY-=14;dr(data.note,mg,rY,8.5,bk);}
    dLine(mg,48,W-mg,48,rgb(.9,.9,.9));dr(T.pFooter,mg,35,6,rgb(.75,.75,.75));
  }else if(tmplId==="receipt"){
    const am=parseFloat(data.amount)||0;let rT=am,rTx=0,pT=am;
    if(S.taxMode==="inclusive"){rTx=Math.floor(am-am/(1+S.taxRate/100));pT=am-rTx;}
    else if(S.taxMode==="exclusive"){rTx=Math.floor(am*S.taxRate/100);rT=am+rTx;pT=am;}
    dRect(0,H-28,W,28,ac);dr(T.pRc,mg,H-72,20,ac);
    drR(`${T.pRcNo}: ${data.receipt_no||""}`,W-mg,H-56,8.5,gr);
    drR(`${T.pDate}: ${fmtD(data.date)}`,W-mg,H-70,8.5,gr);
    dLine(mg,H-88,W-mg,H-88,ac,1.5);
    const sf2=S.lang==="ja"?` ${T.pSama}`:"";dr(`${data.client_name||""}${sf2}`,mg,H-114,13,bk);
    const bxY=H-170;dRect(mg,bxY,W-mg*2,44,ac);dr(T.pAmt,mg+14,bxY+14,11,wh);
    drR(`${fmtC(rT)}-`,W-mg-14,bxY+10,20,wh);
    let dy=bxY-28;dr(T.pFor,mg,dy,8.5,gr);dr(data.detail||"",mg+60,dy,9,bk);
    dy-=20;dLine(mg,dy+8,W-mg,dy+8,rgb(.9,.9,.9));
    if(S.taxMode!=="none"){dy-=6;dr(T.pPreTax,mg,dy,8.5,gr);drR(fmtC(pT),W-mg,dy,9,bk);
    dy-=16;dr(`${T.pTaxAmt} (${S.taxName} ${S.taxRate}%)`,mg,dy,8.5,gr);drR(fmtC(rTx),W-mg,dy,9,bk);}
    dy-=40;dLine(mg,dy+18,W-mg,dy+18,rgb(.9,.9,.9));dr(T.pIssuer,mg,dy,8.5,gr);dy-=16;
    dr(cn,mg,dy,10,bk);dy-=14;if(ca){dr(ca,mg,dy,8,gr);dy-=12;}
    if(ct){dr(`${T.pTel}: ${ct}`,mg,dy,7.5,gr);dy-=11;}if(ci){dr(`${T.pTaxId}: ${ci}`,mg,dy,7.5,gr);}
    dLine(mg,48,W-mg,48,rgb(.9,.9,.9));dr(T.pFooter,mg,35,6,rgb(.75,.75,.75));
  }
  // Watermark
  if(PLANS[plan]?.wm){
    const wt="PDF FLOW FREE",ws=52,ww=font.widthOfTextAtSize(wt,ws);
    pg.drawText(wt,{x:W/2-ww/2+30,y:H/2-20,size:ws,font,color:rgb(.85,.85,.85),rotate:degrees(-30),opacity:.35});
  }
  return doc.save();
}

// --- Parsers ---
function parseCSV(txt){const ls=txt.split(/\r?\n/).filter(l=>l.trim());if(ls.length<2)return[];const hd=ls[0].split(",").map(h=>h.trim().replace(/^"|"$/g,""));return ls.slice(1).map(l=>{const v=[];let c="",q=false;for(const ch of l){if(ch==='"')q=!q;else if(ch===","&&!q){v.push(c.trim());c="";}else c+=ch;}v.push(c.trim());const o={};hd.forEach((h,i)=>{o[h]=v[i]||"";});return o;});}
function parseJSON(txt){const p=JSON.parse(txt);return Array.isArray(p)?p:[p];}
function parseExcel(buf){const wb=XLSX.read(buf,{type:"array"});return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});}

// ============================================================
// Rendering
// ============================================================
function render(){
  const T=t();
  document.getElementById("hdr-sub").textContent=T.appSub;
  document.getElementById("hdr-live").textContent=T.browserOnly;
  document.getElementById("hdr-badge").textContent={free:"Free",standard:"Standard",pro:"Pro",business:"Business"}[plan];
  document.getElementById("hdr-upgrade").textContent=T.upgrade+" →";
  document.getElementById("hdr-upgrade").style.display=plan==="free"?"inline-flex":"none";
  const authBtn=document.getElementById("hdr-auth");
  if(userEmail){authBtn.textContent=userEmail.split("@")[0]+" ▾";authBtn.title=userEmail;}
  else{authBtn.textContent=S.lang==="ja"?"ログイン":"Login";}
  renderSteps();
  const c=document.getElementById("app-content");c.innerHTML="";
  if(step===0)renderStep0(c);
  else if(step===1)renderStep1(c);
  else if(step===2)renderStep2(c);
  else if(step===3)renderStep3(c);
}

function renderSteps(){
  const T=t();const sb=document.getElementById("step-bar");sb.innerHTML="";
  T.steps.forEach((label,i)=>{
    if(i>0){const ln=h("div",`step-line${i<step?" step-line-done":""}`);sb.appendChild(ln);}
    const s=h("div",`step ${i===step?"step-active":i<step?"step-done":"step-pending"}`);
    s.innerHTML=`<span class="num">${i<step?"✓":i+1}</span><span class="step-label">${label}</span>`;
    sb.appendChild(s);
  });
}

// Step 0
function renderStep0(c){
  const T=t(),tmpls=getTmpls();
  c.innerHTML=`<div class="sec-title">${T.selectT}</div><div class="sec-sub">${T.selectTSub}</div>`;
  const grid=h("div","card-grid");
  Object.values(tmpls).forEach(tm=>{
    const card=h("div",`card${selTmpl===tm.id?" selected":""}`,`
      <div class="tmpl-icon">${tm.ic}</div>
      <div class="tmpl-name">${tm.name}</div>
      <div class="tmpl-en">${tm.en}</div>
      <div class="tmpl-desc">${tm.desc}</div>
      <div class="tmpl-fields">${tm.fields.length} ${T.fields}</div>
      ${selTmpl===tm.id?'<div class="tmpl-check">✓</div>':''}`);
    card.style.position="relative";card.style.cursor="pointer";
    card.onclick=()=>{selTmpl=tm.id;render();};
    grid.appendChild(card);
  });
  c.appendChild(grid);
  const nav=h("div","nav-row",`<div></div><button class="btn btn-p"${selTmpl?"":" disabled"} id="s0next">${T.next}</button>`);
  c.appendChild(nav);
  if(selTmpl)document.getElementById("s0next").onclick=()=>{dataRows=[];step=1;render();};
}

// Step 1
function renderStep1(c){
  const T=t(),tmpl=getTmpls()[selTmpl];
  c.innerHTML=`<div class="sec-title">${T.dataInput}</div><div class="sec-sub">${T.dataInputSub}</div>`;
  // Tabs
  const tabs=h("div","tabs");
  let mode=c._mode||"manual";
  ["manual","file"].forEach(m=>{
    const b=h("button",`tab${mode===m?" active":""}`,m==="manual"?T.manual:T.fileImport);
    b.onclick=()=>{c._mode=m;renderStep1(c);};tabs.appendChild(b);});
  c.appendChild(tabs);

  if(mode==="file"){
    const fd=h("div","file-drop",`${IC.folder}<p>${T.fileDrop}</p><span>${T.fileTypes}</span>`);
    const fi=document.createElement("input");fi.type="file";fi.accept=".csv,.xlsx,.xls,.json,.tsv";fi.style.display="none";
    fi.onchange=async e=>{
      const f=e.target.files[0];if(!f)return;const nm=f.name.toLowerCase();
      try{let rows;
        if(nm.endsWith(".csv")||nm.endsWith(".tsv"))rows=parseCSV(await f.text());
        else if(nm.endsWith(".xlsx")||nm.endsWith(".xls"))rows=parseExcel(await f.arrayBuffer());
        else if(nm.endsWith(".json"))rows=parseJSON(await f.text());
        else{alert(T.fileErr);return;}
        if(!rows?.length){alert(T.noData);return;}
        dataRows=rows.map(r=>{const o={};tmpl.fields.forEach(f=>{o[f.key]=r[f.key]??r[f.label]??"";});return o;});
        render();
      }catch(er){alert(T.readErr+": "+er.message);}};
    fd.onclick=()=>fi.click();c.appendChild(fd);c.appendChild(fi);
    if(dataRows.length)c.appendChild(h("p","",`<span style="color:var(--green);font-size:13px;font-weight:600">${dataRows.length} ${T.loaded}</span>`));
  }else{
    const acts=h("div","",`<button class="btn btn-s btn-o" style="margin-right:6px;border-color:#fcd34d;color:#92400e;background:#fffbeb" id="s1sample">${T.sample}</button><button class="btn btn-s btn-o" id="s1add">${T.addRow}</button>`);
    c.appendChild(acts);
    document.getElementById("s1sample")&&setTimeout(()=>{
      document.getElementById("s1sample").onclick=()=>{const r={};tmpl.fields.forEach(f=>{r[f.key]=f.ex;});dataRows=[r];render();};
      document.getElementById("s1add").onclick=()=>{const r={};tmpl.fields.forEach(f=>{r[f.key]="";});dataRows.push(r);render();};
    },0);
  }

  // Data rows
  if(dataRows.length){
    const wrap=h("div","");wrap.style.maxHeight="400px";wrap.style.overflowY="auto";wrap.style.marginTop="12px";
    dataRows.forEach((row,ri)=>{
      const dr_=h("div","data-row");
      dr_.innerHTML=`<div class="data-row-hdr"><span class="data-row-num">#${ri+1}</span><div class="data-row-actions"><button class="dup" data-i="${ri}">${T.dup}</button><button class="del" data-i="${ri}">${T.del}</button></div></div>`;
      const fields=h("div","data-fields");
      tmpl.fields.forEach(f=>{
        const d=h("div","field");d.innerHTML=`<label>${f.label}</label><input value="${(row[f.key]||"").replace(/"/g,"&quot;")}" placeholder="${f.ex}" data-r="${ri}" data-k="${f.key}">`;
        fields.appendChild(d);});
      dr_.appendChild(fields);wrap.appendChild(dr_);});
    c.appendChild(wrap);
    setTimeout(()=>{
      wrap.querySelectorAll("input").forEach(inp=>{inp.oninput=e=>{dataRows[+e.target.dataset.r][e.target.dataset.k]=e.target.value;};});
      wrap.querySelectorAll(".dup").forEach(b=>{b.onclick=e=>{const i=+e.target.dataset.i;dataRows.splice(i+1,0,{...dataRows[i]});render();};});
      wrap.querySelectorAll(".del").forEach(b=>{b.onclick=e=>{dataRows.splice(+e.target.dataset.i,1);render();};});
    },0);
  }
  const hasData=dataRows.length>0&&dataRows.some(r=>Object.values(r).some(v=>v));
  const nav=h("div","nav-row");nav.innerHTML=`<button class="btn btn-ghost" id="s1back">${T.back}</button><button class="btn btn-p" id="s1next"${hasData?"":" disabled"}>${T.next}</button>`;
  c.appendChild(nav);
  setTimeout(()=>{document.getElementById("s1back").onclick=()=>{step=0;render();};if(hasData)document.getElementById("s1next").onclick=()=>{previewIdx=0;step=2;render();};},0);
}

// Step 2
function renderStep2(c){
  const T=t();
  c.innerHTML=`<div class="sec-title">${T.preview}</div><div class="sec-sub">${dataRows.length} ${T.previewOf} ${previewIdx+1} ${T.previewShow}</div>`;
  const nav=h("div","preview-nav");nav.innerHTML=`<button id="pv-prev"${previewIdx===0?" disabled":""}>←</button><span>${previewIdx+1} / ${dataRows.length}</span><button id="pv-next"${previewIdx>=dataRows.length-1?" disabled":""}>→</button>`;
  c.appendChild(nav);
  const frame=h("div","preview-frame");frame.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:13px">${T.gen}</div>`;
  c.appendChild(frame);
  (async()=>{
    const bytes=await genPdf(selTmpl,dataRows[previewIdx]);
    const blob=new Blob([bytes],{type:"application/pdf"});const url=URL.createObjectURL(blob);
    frame.innerHTML=`<iframe src="${url}" style="width:100%;height:100%;border:0"></iframe>`;
  })();
  const navB=h("div","nav-row");navB.innerHTML=`<button class="btn btn-ghost" id="s2back">${T.back}</button><button class="btn btn-p" id="s2next">${T.next}</button>`;
  c.appendChild(navB);
  setTimeout(()=>{
    document.getElementById("pv-prev").onclick=()=>{previewIdx=Math.max(0,previewIdx-1);render();};
    document.getElementById("pv-next").onclick=()=>{previewIdx=Math.min(dataRows.length-1,previewIdx+1);render();};
    document.getElementById("s2back").onclick=()=>{step=1;render();};
    document.getElementById("s2next").onclick=()=>{step=3;render();};
  },0);
}

// Step 3
function renderStep3(c){
  const T=t(),P=PLANS[plan]||PLANS.free;
  const lim=P.limit,rem=lim===-1?Infinity:lim-usage,canGen=rem>=dataRows.length;
  c.innerHTML=`<div class="sec-title">${T.batchGen}</div><div class="sec-sub">${dataRows.length} ${T.batchSub}</div>`;
  // Usage
  const pct=lim===-1?0:Math.min(100,(usage/lim)*100);
  const ubar=h("div","usage");ubar.innerHTML=`<div class="usage-hdr"><span>${T.usage}: ${usage}</span><span>${T.limit}: ${lim===-1?T.unlimited:lim}</span></div><div class="usage-bar"><div class="usage-fill" style="width:${lim===-1?3:pct}%;background:${pct>90?"var(--red)":pct>75?"var(--amber)":"var(--green)"}"></div></div>`;
  c.appendChild(ubar);

  if(!canGen){
    c.innerHTML+=`<div class="limit-ban"><div class="lb-icon">${IC.lock}</div><div><div class="lb-t">${T.limitReached}</div><div class="lb-s">${T.limitSub}</div><button class="btn btn-p btn-s" style="margin-top:8px" onclick="showUpgrade()">${T.upgrade} →</button></div></div>`;
  }else{
    // Format
    c.innerHTML+=`<div class="gen-format"><div class="gen-opt${dlType==="zip"?" active":""}" id="go-zip" style="cursor:pointer">${IC.folder}<div class="go-t">${T.zipL}</div><div class="go-s">${T.zipS}</div></div><div class="gen-opt${dlType==="merged"?" active":""}" id="go-merge" style="cursor:pointer">${IC.merge}<div class="go-t">${T.mergeL}</div><div class="go-s">${T.mergeS}</div></div></div>`;
    if(P.wm)c.innerHTML+=`<div class="wm-notice">${IC.lock} ${T.wm} — <a href="#" onclick="showUpgrade();return false">${T.upgrade}</a></div>`;
    c.innerHTML+=`<div class="priv">${IC.shield}<div><div class="priv-t">${T.priv}</div><div class="priv-s">${T.privS}</div></div></div>`;
    c.innerHTML+=`<button class="btn btn-p" style="width:100%;justify-content:center;padding:14px;font-size:14px" id="s3go">${dataRows.length} ${T.genBtn}</button>`;
    setTimeout(()=>{
      document.getElementById("go-zip").onclick=()=>{dlType="zip";render();};
      document.getElementById("go-merge").onclick=()=>{dlType="merged";render();};
      document.getElementById("s3go").onclick=runGen;
    },0);
  }
  const nav=h("div","nav-row");nav.innerHTML=`<button class="btn btn-ghost" id="s3back">${T.back}</button><div></div>`;
  c.appendChild(nav);
  setTimeout(()=>{document.getElementById("s3back").onclick=()=>{step=2;render();};},0);
}

async function runGen(){
  const T=t(),c=document.getElementById("app-content");
  c.innerHTML=`<div class="progress-wrap"><div class="progress-bar"><div class="progress-fill" id="pf" style="width:0%"></div></div><p style="font-size:13px;color:var(--muted)" id="pp">0%</p></div>`;
  const pf=document.getElementById("pf"),pp=document.getElementById("pp");
  const tmpl=getTmpls()[selTmpl];
  try{
    let dlUrl;
    if(dlType==="zip"){
      const zip=new JSZip();
      for(let i=0;i<dataRows.length;i++){
        const b=await genPdf(selTmpl,dataRows[i]);
        const id=dataRows[i].client_name||dataRows[i].invoice_no||dataRows[i].quote_no||dataRows[i].receipt_no||dataRows[i].delivery_no||String(i+1);
        zip.file(`${tmpl.name}_${id}.pdf`,b);
        const p=Math.round((i+1)/dataRows.length*100);pf.style.width=p+"%";pp.textContent=p+"%";
      }
      dlUrl=URL.createObjectURL(await zip.generateAsync({type:"blob"}));
    }else{
      const merged=await PDFLib.PDFDocument.create();
      for(let i=0;i<dataRows.length;i++){
        const b=await genPdf(selTmpl,dataRows[i]);const src=await PDFLib.PDFDocument.load(b);
        (await merged.copyPages(src,src.getPageIndices())).forEach(p=>merged.addPage(p));
        const p=Math.round((i+1)/dataRows.length*100);pf.style.width=p+"%";pp.textContent=p+"%";
      }
      dlUrl=URL.createObjectURL(new Blob([await merged.save()],{type:"application/pdf"}));
    }
    addUsage(dataRows.length);
    const ext=dlType==="zip"?"zip":"pdf";
    c.innerHTML=`<div class="done-wrap"><div class="done-icon">${IC.check}</div><div class="done-t">${T.done}</div><div class="done-s">${dataRows.length} ${T.doneSub}</div><a href="${dlUrl}" download="${tmpl.name}_${dataRows.length}.${ext}" class="btn btn-p" style="font-size:14px;padding:14px 32px">${T.dl}</a><div style="margin-top:14px"><button class="btn btn-ghost" id="re">${T.retry}</button></div></div>`;
    document.getElementById("re").onclick=()=>{step=3;render();};
  }catch(e){console.error(e);step=3;render();}
}

// --- Settings Panel ---
function openSettings(){document.getElementById("settings-overlay").classList.add("open");renderSettings();}
function closeSettings(){document.getElementById("settings-overlay").classList.remove("open");}
document.getElementById("settings-overlay").onclick=e=>{if(e.target===document.getElementById("settings-overlay"))closeSettings();};

function renderSettings(){
  const T=t(),p=document.getElementById("settings-panel");
  const inp=(lbl,val,key,co)=>`<div class="field"><label>${lbl}</label><input value="${(val||"").toString().replace(/"/g,"&quot;")}" data-sk="${key}"${co?` data-co="${co}`:""}""></div>`;
  p.innerHTML=`
  <div class="sp-hdr"><div><div class="sp-title">${T.settings}</div><div class="sp-sub">${T.settingsSub}</div></div><button class="btn btn-s btn-ghost" onclick="closeSettings()">${T.close}</button></div>
  <div class="sp-body">
    <div class="sp-section"><div class="sp-section-title">${T.lang}</div><div class="sp-row"><button class="sp-btn${S.lang==="ja"?" active":""}" data-lang="ja">日本語</button><button class="sp-btn${S.lang==="en"?" active":""}" data-lang="en">English</button></div></div>
    <div class="sp-section"><div class="sp-section-title">${T.taxSet}</div><div class="sp-row"><button class="sp-btn${S.taxMode==="exclusive"?" active":""}" data-tax="exclusive">${T.taxExcl}</button><button class="sp-btn${S.taxMode==="inclusive"?" active":""}" data-tax="inclusive">${T.taxIncl}</button><button class="sp-btn${S.taxMode==="none"?" active":""}" data-tax="none">${T.noTax}</button></div>
    ${S.taxMode!=="none"?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">${inp(T.taxName,S.taxName,"taxName")}${inp(T.taxRate,S.taxRate,"taxRate")}</div>`:""}</div>
    <div class="sp-section"><div class="sp-section-title">${T.currency}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">${inp(T.symbol,S.currencySymbol,"currencySymbol")}<div class="field"><label>${T.symPos}</label><div class="sp-row" style="margin:0"><button class="sp-btn${S.symbolPosition==="prefix"?" active":""}" data-spos="prefix">${T.pre}</button><button class="sp-btn${S.symbolPosition==="suffix"?" active":""}" data-spos="suffix">${T.suf}</button></div></div>${inp(T.deci,S.decimals,"decimals")}${inp(T.thousSep,S.thousandSep,"thousandSep")}</div></div>
    <div class="sp-section"><div class="sp-section-title">${T.dateFmt}</div><div style="display:flex;flex-wrap:wrap;gap:4px">${["YYYY年M月D日","YYYY-MM-DD","MM/DD/YYYY","DD/MM/YYYY","DD.MM.YYYY"].map(f=>`<button class="sp-btn${S.dateFormat===f?" active":""}" data-df="${f}" style="flex:none;padding:6px 12px">${f}</button>`).join("")}</div></div>
    <div class="sp-section"><div class="sp-section-title">${T.items}</div><div style="display:flex;align-items:center;gap:10px"><input type="range" min="1" max="10" value="${S.maxItems}" class="sp-range" id="sp-items"><span style="font-size:14px;font-weight:700;width:20px;text-align:center" id="sp-items-v">${S.maxItems}</span></div></div>
    <div class="sp-section"><div class="sp-section-title">${T.accent}</div><div style="display:flex;align-items:center;gap:10px"><input type="color" value="${S.accentColor}" id="sp-color" style="width:40px;height:32px;border:0;cursor:pointer;border-radius:4px"><span style="font-size:13px;color:var(--muted);font-family:'JetBrains Mono',mono" id="sp-color-v">${S.accentColor}</span><div class="sp-colors">${["#1e3a5f","#1a1a1a","#0d6e3f","#7c2d12","#4338ca"].map(c=>`<div class="sp-color" data-ac="${c}" style="background:${c}"></div>`).join("")}</div></div></div>
    <div class="sp-section"><div class="sp-section-title">${T.company}</div>${inp(T.coName,S.company.name,"name","1")}${inp(T.coAddr,S.company.address,"address","1")}<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">${inp(T.coTel,S.company.tel,"tel","1")}${inp(T.coEmail,S.company.email,"email","1")}</div>${inp(T.coTaxId,S.company.taxId,"taxId","1")}${inp(T.coBank,S.company.bank,"bank","1")}</div>
  </div>`;
  // Events
  setTimeout(()=>{
    p.querySelectorAll("[data-lang]").forEach(b=>{b.onclick=()=>{S.lang=b.dataset.lang;saveS();render();renderSettings();}});
    p.querySelectorAll("[data-tax]").forEach(b=>{b.onclick=()=>{S.taxMode=b.dataset.tax;saveS();render();renderSettings();}});
    p.querySelectorAll("[data-spos]").forEach(b=>{b.onclick=()=>{S.symbolPosition=b.dataset.spos;saveS();render();renderSettings();}});
    p.querySelectorAll("[data-df]").forEach(b=>{b.onclick=()=>{S.dateFormat=b.dataset.df;saveS();render();renderSettings();}});
    p.querySelectorAll("[data-ac]").forEach(b=>{b.onclick=()=>{S.accentColor=b.dataset.ac;saveS();render();renderSettings();}});
    p.querySelectorAll("[data-sk]").forEach(inp=>{inp.oninput=e=>{const k=e.target.dataset.sk;if(e.target.dataset.co)S.company[k]=e.target.value;else{const v=k==="taxRate"||k==="decimals"?parseFloat(e.target.value)||0:e.target.value;S[k]=v;}saveS();}});
    const ir=document.getElementById("sp-items");if(ir)ir.oninput=e=>{S.maxItems=parseInt(e.target.value);document.getElementById("sp-items-v").textContent=S.maxItems;saveS();};
    const cr=document.getElementById("sp-color");if(cr)cr.oninput=e=>{S.accentColor=e.target.value;document.getElementById("sp-color-v").textContent=e.target.value;saveS();};
  },0);
}

// --- Upgrade Modal ---
function showUpgrade(){document.getElementById("upgrade-overlay").classList.add("open");renderUpgrade();}
function closeUpgrade(){document.getElementById("upgrade-overlay").classList.remove("open");}
document.getElementById("upgrade-overlay").onclick=e=>{if(e.target===document.getElementById("upgrade-overlay"))closeUpgrade();};

function renderUpgrade(){
  const T=t(),m=document.getElementById("upgrade-modal");
  const loggedIn=!!getSession();
  const plans=[["standard","Standard","2,980",T.featStd],["pro","Pro","5,980",T.featPro],["business","Business","9,800",T.featBiz]];
  m.innerHTML=`
  <div class="um-hdr"><h3>${T.upgradeT}</h3><p>${T.upgradeSub}</p></div>
  <div class="um-body">
    ${!loggedIn?`<div style="background:var(--amber-bg);border:1px solid #fcd34d;border-radius:var(--r);padding:14px;margin-bottom:14px">
      <div style="font-size:13px;font-weight:700;color:#92400e;margin-bottom:8px">${S.lang==="ja"?"アップグレードにはログインが必要です":"Login required to upgrade"}</div>
      <div style="display:flex;gap:6px"><input type="email" id="up-email" placeholder="${S.lang==="ja"?"メールアドレス":"Email address"}" style="flex:1;padding:8px 12px;border:1.5px solid #fcd34d;border-radius:8px;font-size:13px;background:#fff;outline:none"><button class="btn btn-p btn-s" id="up-login-btn">${S.lang==="ja"?"ログインリンク送信":"Send Login Link"}</button></div>
      <div id="up-login-msg" style="font-size:11px;color:#92400e;margin-top:6px"></div>
    </div>`:""}
    ${plans.map(([id,n,p,f])=>`
    <div class="um-plan" data-plan="${id}" style="cursor:pointer"><div class="um-plan-hdr"><div><span class="badge">${n}</span> <span class="um-plan-price">${S.lang==="ja"?"¥":"$"}${p}<span style="font-size:11px;font-weight:400;color:var(--muted)">${T.perMo}</span></span></div><span style="font-size:11px;color:var(--accent);font-weight:600">${loggedIn?(S.lang==="ja"?"申し込む →":"Subscribe →"):""}</span></div><div class="um-plan-feat">${f}</div></div>`).join("")}
  </div>
  <div class="um-foot"><div class="priv" style="margin:0">${IC.shield}<div><div class="priv-s">${T.privS}</div></div></div></div>`;
  // Bind events
  setTimeout(()=>{
    if(!loggedIn){
      const loginBtn=document.getElementById("up-login-btn");
      if(loginBtn)loginBtn.onclick=async()=>{
        const email=document.getElementById("up-email").value.trim();
        const msg=document.getElementById("up-login-msg");
        if(!email||!email.includes("@")){msg.textContent=S.lang==="ja"?"メールアドレスを入力してください":"Enter a valid email";return;}
        loginBtn.disabled=true;loginBtn.textContent=S.lang==="ja"?"送信中...":"Sending...";
        try{
          const r=await doLogin(email);
          msg.textContent=S.lang==="ja"?"ログインリンクを送信しました。メールを確認してください。":"Login link sent! Check your email.";
          msg.style.color="#059669";
        }catch(e){msg.textContent=S.lang==="ja"?"送信に失敗しました":"Failed to send";loginBtn.disabled=false;loginBtn.textContent=S.lang==="ja"?"ログインリンク送信":"Send Login Link";}
      };
    }
    document.querySelectorAll("[data-plan]").forEach(el=>{
      el.onclick=()=>{
        if(!loggedIn){
          const emailInput=document.getElementById("up-email");
          if(emailInput)emailInput.focus();
          return;
        }
        doCheckout(el.dataset.plan);
      };
    });
  },0);
}

// Go
init();
</script>
</body>
</html>
